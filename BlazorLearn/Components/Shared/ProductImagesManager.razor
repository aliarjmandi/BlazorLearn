@using BlazorLearn.Data.DTOs
@inject BlazorLearn.Services.Implementations.ProductImageService ImageService
@inject BlazorLearn.Services.Infra.IFileStorage Storage
@rendermode InteractiveServer

<div class="mb-2 d-flex justify-content-between align-items-center">
    <strong>تصاویر محصول</strong>
    <InputFile OnChange="OnFilesSelected" multiple accept="image/*" />
</div>

@if (isLoading)
{
    <p class="text-muted">در حال بارگذاری...</p>
}
else if (images.Count == 0)
{
    <p class="text-muted">هنوز تصویری بارگذاری نشده است.</p>
}
else
{
    <div class="row g-3">
        @foreach (var img in images.OrderBy(x => x.SortOrder))
        {
            <div class="col-6 col-md-3">
                <div class="card shadow-sm h-100">
                    <img class="card-img-top" src="@img.ImageUrl" alt="image" />
                    <div class="card-body p-2 d-flex gap-2 justify-content-between align-items-center">
                        <span class="small text-muted">#@img.SortOrder</span>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" @onclick="() => MoveUp(img)">بالا</button>
                            <button class="btn btn-outline-secondary" @onclick="() => MoveDown(img)">پایین</button>
                            <button class="btn btn-outline-danger" @onclick="() => DeleteAsync(img)">حذف</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter] public Guid ProductId { get; set; }

    private List<ProductImageDto> images = new();
    private bool isLoading = true;

    protected override async Task OnParametersSetAsync()
        => await LoadAsync();

    private async Task LoadAsync()
    {
        isLoading = true;
        images = (await ImageService.GetByProductAsync(ProductId)).ToList();
        isLoading = false;
        StateHasChanged();
    }

    // آپلود چندتایی — ترتیب به صورت خودکار انتهای صف می‌رود (در سرویس)
    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            // مسیر وب (مثلاً /uploads/products/{pid}/xxxx.ext)
            var rel = await Storage.SaveProductImageAsync(ProductId, file);

            var dto = new ProductImageWriteDto
            {
                ProductId = ProductId,
                ImageUrl = rel,
                // SortOrder عملاً در INSERT نادیده گرفته می‌شود و انتهای صف محاسبه می‌شود
                SortOrder = 0,
                IsActive = true,
                CreatedAt = DateTime.UtcNow
            };

            await ImageService.CreateAsync(dto);
        }
        await LoadAsync();
    }

    // حذف + حذف فایل + بازشماری (همه داخل سرویس هندل می‌شود)
    private async Task DeleteAsync(ProductImageDto img)
    {
        await ImageService.DeleteAndReindexAsync(img.Id, ProductId);
        await Storage.DeleteAsync(img.ImageUrl);
        await LoadAsync();
    }

    // حرکت به بالا/پایین (Swap داخلی + بازنویسی SortOrder در سرویس)
    private async Task MoveUp(ProductImageDto img)
    {
        await ImageService.MoveUpAsync(img.Id, ProductId);
        await LoadAsync();
    }

    private async Task MoveDown(ProductImageDto img)
    {
        await ImageService.MoveDownAsync(img.Id, ProductId);
        await LoadAsync();
    }
}
