@rendermode InteractiveServer
@using BlazorLearn.Data.DTOs
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

@inject IFileStorageService Storage

@code {
    [Parameter] public CategoryWriteDto Dto { get; set; } = default!;
    [Parameter] public EventCallback<CategoryWriteDto> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private async Task Save(MouseEventArgs _)
    {
        Dto.IconUrl = NormalizeWebPath(Dto.IconUrl ?? "");
        Dto.ImageUrl = NormalizeWebPath(Dto.ImageUrl ?? "");
        await OnSave.InvokeAsync(Dto);
    }

    private async Task Cancel(MouseEventArgs _) => await OnCancel.InvokeAsync();

    // --- آپلود ---
    private static string NormalizeWebPath(string p)
    {
        if (string.IsNullOrWhiteSpace(p)) return p;
        p = p.Replace("\\", "/").Trim();
        // حذف کوتیشن اشتباهی
        if (p.StartsWith("'") || p.StartsWith("\"")) p = p[1..];
        if (p.EndsWith("'") || p.EndsWith("\"")) p = p[..^1];
        // حذف اسلش‌های اضافی انتها
        while (p.EndsWith("//")) p = p[..^1];
        // اضافه کردن اسلش ابتدای مسیر نسبی
        if (!p.StartsWith("http", StringComparison.OrdinalIgnoreCase) && !p.StartsWith("/"))
            p = "/" + p;
        return p;
    }

    private async Task OnIconFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File; if (file is null) return;
        EnsureId();
        var ext = Path.GetExtension(file.Name);
        var rel = $"uploads/categories/{Dto.Id}/icon{ext.ToLowerInvariant()}";
        var saved = await Storage.SaveAsync(file, rel);
        Dto.IconUrl = NormalizeWebPath(saved);
        StateHasChanged();
    }

    private async Task OnImageFileChange(InputFileChangeEventArgs e)
    {
        var file = e.File; if (file is null) return;
        EnsureId();
        var ext = Path.GetExtension(file.Name);
        var rel = $"uploads/categories/{Dto.Id}/image{ext.ToLowerInvariant()}";
        var saved = await Storage.SaveAsync(file, rel);
        Dto.ImageUrl = NormalizeWebPath(saved);
        StateHasChanged();
    }





    private void EnsureId()
    {
        if (Dto.Id is null || Dto.Id == Guid.Empty)
            Dto.Id = Guid.NewGuid();
    }
}

<div class="row g-2 align-items-end">
    <div class="col-md-3">
        <label class="form-label">نام</label>
        <input class="form-control" @bind="Dto.Name" />
    </div>

    <div class="col-md-3">
        <label class="form-label">Slug</label>
        <input class="form-control" @bind="Dto.Slug" />
    </div>

    <div class="col-md-2">
        <label class="form-label">Sort</label>
        <input type="number" class="form-control" @bind="Dto.SortOrder" />
    </div>

    <div class="col-md-2 form-check mt-4">
        <input class="form-check-input" type="checkbox"
               id="@($"active-{Guid.NewGuid()}")" @bind="Dto.IsActive" />
        <label class="form-check-label">Active</label>
    </div>

    <div class="col-md-2 d-flex gap-2">
        <button class="btn btn-primary" @onclick="Save">ذخیره</button>
        <button class="btn btn-outline-secondary" @onclick="Cancel">انصراف</button>
    </div>
</div>

<!-- آیکن/تصویر -->
<div class="row g-2 mt-3 align-items-center">
    <div class="col-md-6">
        <label class="form-label">آیکن (سطوح ۱/۲)</label>
        <div class="input-group">
            <input class="form-control" @bind="Dto.IconUrl" placeholder="/uploads/categories/{id}/icon.svg" />
            <label for="iconFile" class="btn btn-outline-secondary">آپلود…</label>
            <InputFile id="iconFile" class="d-none" OnChange="OnIconFileChange"
                       accept=".svg,.png,.webp,.jpg,.jpeg" />
        </div>
        @if (!string.IsNullOrWhiteSpace(Dto.IconUrl))
        {
            <img src="@Dto.IconUrl" alt="icon" style="width:36px;height:36px;object-fit:contain;margin-top:.5rem;border:1px solid #e5e7eb;border-radius:.25rem" />
        }
    </div>

    <div class="col-md-6">
        <label class="form-label">تصویر دسته (سطح ۳)</label>
        <div class="input-group">
            <input class="form-control" @bind="Dto.ImageUrl" placeholder="/uploads/categories/{id}/image.webp" />
            <label for="imageFile" class="btn btn-outline-secondary">آپلود…</label>
            <InputFile id="imageFile" class="d-none" OnChange="OnImageFileChange"
                       accept=".webp,.png,.jpg,.jpeg,.avif" />
        </div>
        @if (!string.IsNullOrWhiteSpace(Dto.ImageUrl))
        {
            <img src="@Dto.ImageUrl" alt="image" style="width:80px;height:80px;object-fit:contain;margin-top:.5rem;border:1px solid #e5e7eb;border-radius:.5rem" />
        }
    </div>
</div>
