@page "/admin/products"
@using BlazorLearn.Common
@using BlazorLearn.Data.DTOs
@using BlazorLearn.Components.Shared
@using System.Globalization
@inject BlazorLearn.Services.Implementations.ProductService ProductService
@inject BlazorLearn.Services.Implementations.CategoryService CategoryService
@inject BlazorLearn.Services.Implementations.UnitService UnitService
@inject IJSRuntime JS
@rendermode InteractiveServer


<h3>مدیریت محصولات</h3>

<EditForm EditContext="_editContext" OnValidSubmit="SaveAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row g-3 align-items-end mb-3">
        <div class="col-md-2">
            <label class="form-label">SKU</label>
            <InputText class="form-control" @bind-Value="model.Sku" />
            <ValidationMessage For="@(() => model.Sku)" />
        </div>

        <div class="col-md-3">
            <label class="form-label">نام</label>
            <InputText class="form-control" @bind-Value="model.Name" @oninput="(e) => OnNameChanged()" />
            <ValidationMessage For="@(() => model.Name)" />
        </div>

        <div class="col-md-3">
            <label class="form-label">Slug</label>
            <InputText class="form-control" @bind-Value="model.Slug" />
            <ValidationMessage For="@(() => model.Slug)" />
        </div>

        <!-- فیلد دسته + دکمه انتخاب -->
        <div class="col-md-3">
            <label class="form-label">دسته</label>
            <div class="input-group">
                <input class="form-control" value="@selectedCategoryName" readonly />
                <button type="button" class="btn btn-outline-secondary" @onclick="ShowCategoryModal">
                    انتخاب…
                </button>
            </div>
        </div>

        <div class="col-md-2">
            <label class="form-label">واحد</label>
            <InputSelect class="form-select" @bind-Value="model.UnitId">
                <option value="">-- انتخاب --</option>
                @foreach (var u in units)
                {
                    <option value="@u.Id">@u.Name</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => model.UnitId)" />
        </div>

        <!-- قیمت با جداکننده هزار در حین تایپ -->
        <div class="col-md-2">
            <label class="form-label">قیمت (تومان)</label>
            <InputThousands @bind-Value="priceTemp"
                            Class="form-control text-start"
                            Locale="fa-IR"
                            Format="N0" />
        </div>

        <!-- درصد تخفیف -->
        <div class="col-md-2">
            <label class="form-label">%تخفیف</label>
            <InputNumber @bind-Value="model.DiscountPercent"
                         @bind-Value:format="N0"
                         class="form-control text-start"
                         inputmode="numeric" />
        </div>

        <!-- موجودی -->
        <div class="col-md-2">
            <label class="form-label">موجودی</label>
            <InputNumber @bind-Value="model.Stock"
                         @bind-Value:format="N0"
                         class="form-control text-start"
                         inputmode="numeric" />
        </div>

        <div class="col-md-6">
            <label class="form-label">خلاصه</label>
            <InputText class="form-control" @bind-Value="model.ShortDescription" />
        </div>

        <div class="col-12">
            <label class="form-label">توضیحات</label>
            <InputTextArea class="form-control" @bind-Value="model.Description" rows="3" />
        </div>

        <div class="col-md-2">
            <label class="form-label d-block">فعال</label>
            <InputCheckbox class="form-check-input" @bind-Value="model.IsActive" />
        </div>

        <div class="col-md-10 d-flex gap-2 justify-content-end">
            <button type="submit" class="btn btn-primary">@(isEditing ? "به‌روزرسانی" : "ذخیره")</button>
            @if (isEditing)
            {
                <button type="button" class="btn btn-outline-secondary" @onclick="CancelEdit">انصراف</button>
            }
        </div>
    </div>
</EditForm>

<!-- مدال انتخاب دسته -->
<div class="modal fade" id="categoryPickerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">انتخاب دسته</h5>
                <button type="button" class="btn-close ms-0 me-auto" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <CategoryPicker SelectedId="model.CategoryId"
                                OnPicked="OnCategoryPicked" />
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">جستجو بر اساس SKU</label>
                <InputText class="form-control" @bind-Value="filterSku" />
            </div>
            <div class="col-md-3">
                <label class="form-label">نام کالا</label>
                <InputText class="form-control" @bind-Value="filterName" />
            </div>
            <div class="col-md-3">
                <label class="form-label">دسته</label>
                <InputSelect class="form-select" @bind-Value="filterCategoryId">
                    <option value="">-- همه --</option>
                    @foreach (var c in categories)
                    {
                        <option value="@c.Id">@c.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-2">
                <label class="form-label">وضعیت</label>
                <InputSelect class="form-select" @bind-Value="filterIsActive">
                    <option value="">-- همه --</option>
                    <option value="true">فعال</option>
                    <option value="false">غیرفعال</option>
                </InputSelect>
            </div>
            <div class="col-md-1 d-grid">
                <button type="button" class="btn btn-primary" @onclick="() => LoadPageAsync(1)">اعمال</button>
            </div>
        </div>
    </div>
</div>


@if (isLoading)
{
    <p>در حال بارگذاری...</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th class="text-center">تصویر</th>
                    <th>SKU</th>
                    <th>نام</th>
                    <th>دسته</th>
                    <th>واحد</th>
                    <th>قیمت</th>
                    <th>%تخفیف</th>
                    <th>موجودی</th>
                    <th class="text-center">فعال</th>
                    <th>ثبت</th>
                    <th style="width:180px"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in items)
                {
                    <tr>
                        <!-- ⭐ ستون عکس -->
                        <td class="text-center prod-thumb-cell">
                            <button class="btn btn-link p-0" title="مدیریت تصاویر"
                                    @onclick="() => OpenImages(p)">
                                <img loading="lazy" 
                                     class="prod-thumb"
                                     alt="@p.Name"
                                     src="@GetProductThumb(p)" />
                            </button>
                        </td>

                        <td>@p.Sku</td>
                        <td>@p.Name</td>
                        <td>@p.CategoryName</td>
                        <td>@p.UnitName</td>
                        <td>@p.Price.ToString("N0")</td>
                        <td>@p.DiscountPercent.ToString("N0")</td>
                        <td>@p.Stock.ToString("N0")</td>
                        <td class="text-center">
                            <div class="form-check form-switch d-inline-block">
                                <input type="checkbox" class="form-check-input"
                                       checked="@p.IsActive"
                                       @onchange="(e) => ToggleActive(p, e.Value as bool?)" />
                            </div>
                        </td>
                        <td>@p.CreatedAt.ToString("yyyy/MM/dd HH:mm")</td>
                        <td class="text-end">
                            <button class="btn btn-outline-primary btn-sm" @onclick="() => BeginEdit(p)">ویرایش</button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="() => AskDelete(p)">حذف</button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => OpenImages(p)">تصاویر</button>
                        </td>
                    </tr>
                }
            </tbody>

        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-2">
        <div class="text-muted small">
            نمایش @(items.Count) ردیف از @totalCount (صفحه @pageNumber از @totalPages)
        </div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
                    <button type="button" class="page-link" @onclick="() => LoadPageAsync(1)">اول</button>
                </li>
                <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
                    <button type="button" class="page-link" @onclick="() => LoadPageAsync(pageNumber - 1)">قبلی</button>
                </li>
                <li class="page-item disabled"><span class="page-link">@pageNumber / @totalPages</span></li>
                <li class="page-item @(pageNumber >= totalPages ? "disabled" : "")">
                    <button type="button" class="page-link" @onclick="() => LoadPageAsync(pageNumber + 1)">بعدی</button>
                </li>
                <li class="page-item @(pageNumber >= totalPages ? "disabled" : "")">
                    <button type="button" class="page-link" @onclick="() => LoadPageAsync(totalPages)">آخر</button>
                </li>
            </ul>
        </nav>
    </div>
}

<ConfirmModal ModalId="confirmDeleteProduct"
              Title="تأیید حذف"
              ConfirmText="حذف"
              CancelText="انصراف"
              OnConfirm="ConfirmDeleteAsync">
    <Message>
        @if (toDelete is not null)
        {
            <p>حذف محصول «<strong>@toDelete.Name</strong>»؟</p>
        }
    </Message>
</ConfirmModal>

@code {
    // Bridge بین decimal? و decimal
    private decimal? priceTemp
    {
        get => model.Price;              // model.Price از نوع decimal (غیرnullable)
        set => model.Price = value ?? 0; // اگر پاک شد، 0 بگذار یا مقدار قبلی را نگه دار
    }
    private bool isLoading = true;
    private bool isEditing = false;

    // صفحه‌بندی
    private int pageNumber = 1;
    private int pageSize = 10;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);

    //فیلترها
    private string? filterSku;
    private string? filterName;
    private Guid? filterCategoryId;
    private bool? filterIsActive;

    private List<ProductDto> items = new();
    private List<CategoryDto> categories = new();
    private List<UnitDto> units = new();


    private string selectedCategoryName = "";

    private async Task OnCategoryPicked(CategoryTreeNodeDto node)
    {
        model.CategoryId = node.Id;
        selectedCategoryName = node.Name;
        await InvokeAsync(StateHasChanged);
        await JS.InvokeVoidAsync("modalHelper.hide", "categoryPickerModal");
    }

    private async Task ShowCategoryModal()
    {
        await JS.InvokeVoidAsync("modalHelper.show", "categoryPickerModal");
    }

    private static string GetInitial(string? name)
    => string.IsNullOrWhiteSpace(name) ? "?" : name.Trim()[0].ToString();


    private string GetProductThumb(ProductDto p)
    => string.IsNullOrWhiteSpace(p.FirstImageUrl)
        ? "/images/placeholder-product.png"   // یک آیکون پیش‌فرض کوچک (دلخواه)
        : p.FirstImageUrl;

    private ProductWriteDto model = new()
    {
        IsActive = true,
        CreatedAt = DateTime.Now
    };

    private EditContext _editContext = default!;
    private ProductDto? toDelete;

    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(model);
        // منابع انتخابی
        categories = (await CategoryService.GetAllAsync()).Where(c => c.IsActive).OrderBy(c => c.Name).ToList();
        units = (await UnitService.GetAllAsync()).Where(u => u.IsActive).OrderBy(u => u.Name).ToList();



        // اگر در حالت ویرایش هستی نام دسته را برای نمایش بخوان
        if (model.CategoryId != Guid.Empty)
        {
            var all = (await CategoryService.GetAllAsync()).ToList();
            selectedCategoryName = all.FirstOrDefault(x => x.Id == model.CategoryId)?.Name ?? "";
        }

        await LoadPageAsync(1);
    }

    private async Task LoadPageAsync(int page)
    {
        isLoading = true;
        pageNumber = Math.Max(1, page);

        var result = await ProductService.GetPagedAsync(
            pageNumber, pageSize,
            sku: filterSku,
            name: filterName,
            categoryId: (filterCategoryId.HasValue && filterCategoryId.Value != Guid.Empty) ? filterCategoryId : null,
            isActive: filterIsActive
        );

        items = result.Items.ToList();
        totalCount = result.TotalCount;
        isLoading = false;
        StateHasChanged();
    }

    private async Task ReloadAsync() => await LoadPageAsync(pageNumber);

    private async Task SaveAsync()
    {
        // 1) ساخت اسلاگ پایه با Utility
        var baseSlug = string.IsNullOrWhiteSpace(model.Slug)
            ? SlugUtility.Slugify(model.Name)
            : SlugUtility.Slugify(model.Slug);

        // 2) یکتا کردن اسلاگ (در ویرایش، آی‌دی فعلی را نادیده بگیر)
        model.Slug = await ProductService.EnsureUniqueSlugAsync(baseSlug, ignoreId: model.Id);

        if (!isEditing)
        {
            model.CreatedAt = DateTime.Now;
            await ProductService.CreateAsync(model);
            await LoadPageAsync(1);  // جدیدترین بالا
        }
        else
        {
            if (model.Id is null) return;
            await ProductService.UpdateAsync(model.Id.Value, model);
            await ReloadAsync();
        }

        ResetForm();
    }


    private void BeginEdit(ProductDto p)
    {
        isEditing = true;
        model = new ProductWriteDto
        {
            Id = p.Id,
            Sku = p.Sku,
            Name = p.Name,
            Slug = p.Slug,
            CategoryId = p.CategoryId,
            UnitId = p.UnitId,
            Price = p.Price,
            DiscountPercent = p.DiscountPercent,
            Stock = p.Stock,
            ShortDescription = p.ShortDescription,
            Description = p.Description,
            IsActive = p.IsActive,
            CreatedAt = p.CreatedAt
        };
        // ست کردن نام برای نمایش در input readonly
        selectedCategoryName = categories.FirstOrDefault(x => x.Id == p.CategoryId)?.Name ?? "";

        _editContext = new EditContext(model);
    }

    private void CancelEdit() => ResetForm();

    private void ResetForm()
    {
        isEditing = false;
        model = new ProductWriteDto
        {
            IsActive = true,
            CreatedAt = DateTime.Now
        };
        selectedCategoryName = "";  // پاک شود
        _editContext = new EditContext(model);
    }

    private async Task ToggleActive(ProductDto p, bool? val)
    {
        if (val is null) return;
        var dto = new ProductWriteDto
        {
            Id = p.Id,
            Sku = p.Sku,
            Name = p.Name,
            Slug = p.Slug,
            CategoryId = p.CategoryId,
            UnitId = p.UnitId,
            Price = p.Price,
            DiscountPercent = p.DiscountPercent,
            Stock = p.Stock,
            ShortDescription = p.ShortDescription,
            Description = p.Description,
            IsActive = val.Value,
            CreatedAt = p.CreatedAt
        };
        await ProductService.UpdateAsync(p.Id, dto);
        await ReloadAsync();
    }

    private async Task AskDelete(ProductDto p)
    {
        toDelete = p;
        await JS.InvokeVoidAsync("modalHelper.show", "confirmDeleteProduct");
    }

    private async Task ConfirmDeleteAsync()
    {
        if (toDelete is null) return;
        await ProductService.DeleteAsync(toDelete.Id);
        toDelete = null;
        await JS.InvokeVoidAsync("modalHelper.hide", "confirmDeleteProduct");
        await ReloadAsync();
    }

    private static string Slugify(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return "";
        var s = input.Trim();
        s = s.Replace(' ', '-').Replace('/', '-').Replace('\\', '-');
        return s.ToLowerInvariant();
    }

    private void OnNameChanged()
    {
        if (!isEditing && string.IsNullOrWhiteSpace(model.Slug) && !string.IsNullOrWhiteSpace(model.Name))
            model.Slug = Slugify(model.Name);
    }

    private Guid imagesForProductId;
    private async Task OpenImages(ProductDto p)
    {
        imagesForProductId = p.Id;
        await JS.InvokeVoidAsync("modalHelper.show", "productImagesModal");
    }

}

<div class="modal fade" id="productImagesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between align-items-center">
                <!-- عنوان -->
                <h5 class="modal-title">مدیریت تصاویر محصول</h5>
                <button type="button" class="btn-close ms-0 me-auto" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @if (imagesForProductId != Guid.Empty)
                {
                    <ProductImagesManager ProductId="imagesForProductId" />
                }
            </div>
        </div>
    </div>
</div>
